> if (FALSE)
+ {"
+ Robust Regression is performed in R using the quantreg package
+ 
+ Least absolute deviation (LAD) regression is an alternative to 
+ ordinary least squares (OLS) regression that has greater power
+ for thick-tailed symmetric and asymmetric error distributions (Cade and Richards 1996).
+ 
+ LAD regression estimates the median (a 0.50 quantile) of a dependent variable
+ given the independent variable(s) by minimizing sums of absolute deviations
+ between observed and predicted values. LAD regression can be used anywhere
+ OLS regression would be used but is often more desirable because it is less
+ sensitive to outlying data points and is more efficient for skewed error distributions
+ as well as some symmetric error distributions.
+ 
+ LAD Least Absolute Deviations is the default robust regression procedure that is used.
+ generate the growprice data set - Taiwan city prices
+ "}
> 
> year <- 40:46
> price = c(1.62, 1.63, 1.90, 2.64, 2.05, 2.13, 1.94)
> 
> growprice <- data.frame(year,price)
> growprice
  year price
1   40  1.62
2   41  1.63
3   42  1.90
4   43  2.64
5   44  2.05
6   45  2.13
7   46  1.94
> summary(growprice)
      year          price      
 Min.   :40.0   Min.   :1.620  
 1st Qu.:41.5   1st Qu.:1.765  
 Median :43.0   Median :1.940  
 Mean   :43.0   Mean   :1.987  
 3rd Qu.:44.5   3rd Qu.:2.090  
 Max.   :46.0   Max.   :2.640  
> 
> windows(7,7)
> #now save the ecdf in a pdf file
>  pdf(file="C:/users/jmard/Desktop/Computing and Graphics in Applied Statistics2020/Lecture 07 11Feb2020/RobustRegressioncityR_out.pdf")
> 
> 
> plot(price~year,growprice)
> lmod <-lm(price~year,growprice) #perform OLS.  Also the Maximum Likelihood Estimator for B0, B1.
> abline(lmod,col="red",lty=2)
> 
> summary(lmod)

Call:
lm(formula = price ~ year, data = growprice)

Residuals:
        1         2         3         4         5         6         7 
-0.141071 -0.206429 -0.011786  0.652857 -0.012500 -0.007857 -0.273214 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)
(Intercept) -1.25321    2.73157  -0.459    0.666
year         0.07536    0.06346   1.188    0.288

Residual standard error: 0.3358 on 5 degrees of freedom
Multiple R-squared:   0.22,     Adjusted R-squared:  0.064 
F-statistic:  1.41 on 1 and 5 DF,  p-value: 0.2883

> names(lmod) #provides the names of the different objects from a regression
 [1] "coefficients"  "residuals"     "effects"       "rank"         
 [5] "fitted.values" "assign"        "qr"            "df.residual"  
 [9] "xlevels"       "call"          "terms"         "model"        
> 
> ei <- residuals(lmod)
> ei
           1            2            3            4            5            6 
-0.141071429 -0.206428571 -0.011785714  0.652857143 -0.012500000 -0.007857143 
           7 
-0.273214286 
> eisq <- ei^2
> eisq
           1            2            3            4            5            6 
1.990115e-02 4.261276e-02 1.389031e-04 4.262224e-01 1.562500e-04 6.173469e-05 
           7 
7.464605e-02 
> 
> 
> stem(eisq) #stem and leaf display of residuals squared

  The decimal point is 1 digit(s) to the left of the |

  0 | 000247
  1 | 
  2 | 
  3 | 
  4 | 3

> sum(eisq) #this quantity is minimized for OLS
[1] 0.5637393
> 
> require(quantreg)
> LADmodel <-rq(price ~ year,model=TRUE,data=growprice,alpha=0.05) #perform LAD regression
> summary(LADmodel)

Call: rq(formula = price ~ year, data = growprice, model = TRUE, alpha = 0.05)

tau: [1] 0.5

Coefficients:
            coefficients lower bd upper bd
(Intercept) -2.46000     -5.23449  4.34349
year         0.10200     -0.04404  0.22614
> 
> #boot.rq performs bootstrapping to obtain confidence intervals on the Beta parameters
> boot.rq(x=year, y=price, tau = 0.5, R = 200, se="boot", bsmethod = "xy")  #tau = 0.5 indicates LAD regression
$B
             [,1]
  [1,] 0.04733333
  [2,] 0.04523810
  [3,] 0.04050000
  [4,] 0.04659091
  [5,] 0.04659091
  [6,] 0.04523810
  [7,] 0.04217391
  [8,] 0.04659091
  [9,] 0.04217391
 [10,] 0.04217391
 [11,] 0.04659091
 [12,] 0.04659091
 [13,] 0.04659091
 [14,] 0.04050000
 [15,] 0.04523810
 [16,] 0.04217391
 [17,] 0.04523810
 [18,] 0.04217391
 [19,] 0.04659091
 [20,] 0.04050000
 [21,] 0.04217391
 [22,] 0.04523810
 [23,] 0.04050000
 [24,] 0.04523810
 [25,] 0.04733333
 [26,] 0.04217391
 [27,] 0.04217391
 [28,] 0.04523810
 [29,] 0.04659091
 [30,] 0.04523810
 [31,] 0.04659091
 [32,] 0.04050000
 [33,] 0.04217391
 [34,] 0.04217391
 [35,] 0.04217391
 [36,] 0.04659091
 [37,] 0.04523810
 [38,] 0.04523810
 [39,] 0.04217391
 [40,] 0.04050000
 [41,] 0.04523810
 [42,] 0.04733333
 [43,] 0.04659091
 [44,] 0.04050000
 [45,] 0.04217391
 [46,] 0.04733333
 [47,] 0.04523810
 [48,] 0.04733333
 [49,] 0.04217391
 [50,] 0.04523810
 [51,] 0.04217391
 [52,] 0.04523810
 [53,] 0.04659091
 [54,] 0.04217391
 [55,] 0.04050000
 [56,] 0.04050000
 [57,] 0.04523810
 [58,] 0.04659091
 [59,] 0.04050000
 [60,] 0.04523810
 [61,] 0.04659091
 [62,] 0.04523810
 [63,] 0.04523810
 [64,] 0.04050000
 [65,] 0.03975610
 [66,] 0.04523810
 [67,] 0.04217391
 [68,] 0.04523810
 [69,] 0.04523810
 [70,] 0.04050000
 [71,] 0.04659091
 [72,] 0.04523810
 [73,] 0.04733333
 [74,] 0.04523810
 [75,] 0.04659091
 [76,] 0.04217391
 [77,] 0.04217391
 [78,] 0.04659091
 [79,] 0.04523810
 [80,] 0.04523810
 [81,] 0.04523810
 [82,] 0.04659091
 [83,] 0.04523810
 [84,] 0.04659091
 [85,] 0.04659091
 [86,] 0.04523810
 [87,] 0.04217391
 [88,] 0.04217391
 [89,] 0.04523810
 [90,] 0.04659091
 [91,] 0.04217391
 [92,] 0.04659091
 [93,] 0.04217391
 [94,] 0.04523810
 [95,] 0.04523810
 [96,] 0.04659091
 [97,] 0.04523810
 [98,] 0.04217391
 [99,] 0.04523810
[100,] 0.04217391
[101,] 0.04523810
[102,] 0.04217391
[103,] 0.04659091
[104,] 0.04050000
[105,] 0.04523810
[106,] 0.04217391
[107,] 0.04523810
[108,] 0.04659091
[109,] 0.04733333
[110,] 0.04523810
[111,] 0.04523810
[112,] 0.04050000
[113,] 0.04217391
[114,] 0.04217391
[115,] 0.04050000
[116,] 0.04523810
[117,] 0.04217391
[118,] 0.04523810
[119,] 0.04659091
[120,] 0.04523810
[121,] 0.04523810
[122,] 0.04659091
[123,] 0.04217391
[124,] 0.04523810
[125,] 0.04659091
[126,] 0.04659091
[127,] 0.04523810
[128,] 0.04523810
[129,] 0.04523810
[130,] 0.04733333
[131,] 0.04523810
[132,] 0.04523810
[133,] 0.04050000
[134,] 0.04523810
[135,] 0.04523810
[136,] 0.04733333
[137,] 0.04523810
[138,] 0.04217391
[139,] 0.04733333
[140,] 0.04217391
[141,] 0.04659091
[142,] 0.04217391
[143,] 0.04217391
[144,] 0.04217391
[145,] 0.04523810
[146,] 0.04659091
[147,] 0.04217391
[148,] 0.04659091
[149,] 0.04523810
[150,] 0.04050000
[151,] 0.04659091
[152,] 0.04659091
[153,] 0.04659091
[154,] 0.04659091
[155,] 0.04217391
[156,] 0.04217391
[157,] 0.04733333
[158,] 0.04217391
[159,] 0.04733333
[160,] 0.04733333
[161,] 0.04523810
[162,] 0.04659091
[163,] 0.04217391
[164,] 0.04659091
[165,] 0.04523810
[166,] 0.04523810
[167,] 0.04523810
[168,] 0.04217391
[169,] 0.04523810
[170,] 0.04217391
[171,] 0.04523810
[172,] 0.04659091
[173,] 0.04217391
[174,] 0.04659091
[175,] 0.04733333
[176,] 0.04217391
[177,] 0.04217391
[178,] 0.04659091
[179,] 0.04523810
[180,] 0.04523810
[181,] 0.04659091
[182,] 0.04050000
[183,] 0.04050000
[184,] 0.04217391
[185,] 0.04523810
[186,] 0.04659091
[187,] 0.04523810
[188,] 0.04217391
[189,] 0.04217391
[190,] 0.04523810
[191,] 0.04217391
[192,] 0.04050000
[193,] 0.04050000
[194,] 0.04523810
[195,] 0.04523810
[196,] 0.04659091
[197,] 0.04523810
[198,] 0.04523810
[199,] 0.04523810
[200,] 0.04733333

$U
     [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10] [,11] [,12] [,13] [,14]
[1,]    4    6    2    2    4    7    2    4    5     5     5     4     7     1
[2,]    2    3    6    2    7    7    3    1    7     7     6     4     5     1
[3,]    6    7    2    6    6    5    7    2    4     7     6     5     4     7
[4,]    6    6    4    2    2    7    4    3    7     1     5     7     2     6
[5,]    2    1    1    4    7    6    1    5    5     2     5     5     3     1
[6,]    4    1    7    5    5    6    4    4    2     5     3     1     6     2
[7,]    2    4    1    4    6    3    2    4    7     2     1     4     6     4
     [,15] [,16] [,17] [,18] [,19] [,20] [,21] [,22] [,23] [,24] [,25] [,26]
[1,]     7     2     3     1     5     3     2     5     2     7     5     7
[2,]     3     1     6     7     7     3     7     2     2     3     6     5
[3,]     1     7     1     2     2     2     3     2     4     4     1     3
[4,]     3     6     4     4     2     1     3     7     1     3     6     7
[5,]     3     7     1     2     6     4     7     5     6     7     4     1
[6,]     6     5     1     7     4     2     1     5     6     4     6     7
[7,]     1     6     6     4     4     1     4     3     1     5     2     7
     [,27] [,28] [,29] [,30] [,31] [,32] [,33] [,34] [,35] [,36] [,37] [,38]
[1,]     7     6     7     6     4     7     1     2     5     5     4     4
[2,]     6     3     5     2     6     4     5     5     6     3     7     6
[3,]     7     1     5     5     2     1     7     7     5     2     7     3
[4,]     2     4     6     3     5     1     4     6     2     6     4     2
[5,]     2     7     7     5     2     3     1     4     7     6     3     5
[6,]     3     2     2     2     5     1     3     1     2     6     7     1
[7,]     5     6     6     3     2     2     7     2     7     5     4     3
     [,39] [,40] [,41] [,42] [,43] [,44] [,45] [,46] [,47] [,48] [,49] [,50]
[1,]     7     2     4     1     6     7     1     6     3     7     3     4
[2,]     7     2     3     6     5     2     7     2     5     6     7     6
[3,]     6     6     3     3     1     1     6     4     7     6     7     3
[4,]     6     2     1     1     1     2     6     4     3     4     2     2
[5,]     7     1     2     6     5     6     7     1     2     2     1     2
[6,]     1     4     6     6     5     5     2     4     3     6     1     2
[7,]     6     6     4     6     7     1     1     5     4     2     4     5
     [,51] [,52] [,53] [,54] [,55] [,56] [,57] [,58] [,59] [,60] [,61] [,62]
[1,]     7     7     1     7     7     1     6     4     1     2     7     5
[2,]     1     1     6     3     1     6     5     3     5     5     6     2
[3,]     6     4     2     1     7     6     3     1     1     7     2     5
[4,]     5     3     4     1     6     1     7     5     2     2     6     1
[5,]     2     7     4     4     1     2     3     3     6     3     4     3
[6,]     6     4     5     4     2     1     3     5     4     5     5     3
[7,]     2     5     5     1     2     2     7     5     1     6     5     1
     [,63] [,64] [,65] [,66] [,67] [,68] [,69] [,70] [,71] [,72] [,73] [,74]
[1,]     1     2     2     3     3     4     3     4     5     6     6     4
[2,]     4     5     3     3     3     3     4     2     7     3     6     7
[3,]     7     2     2     2     5     2     7     6     1     2     1     3
[4,]     6     4     2     1     2     3     7     2     4     1     5     6
[5,]     6     1     5     5     1     4     1     1     5     3     6     6
[6,]     2     1     2     6     7     7     4     7     4     3     4     2
[7,]     3     1     6     7     7     4     4     2     6     7     1     1
     [,75] [,76] [,77] [,78] [,79] [,80] [,81] [,82] [,83] [,84] [,85] [,86]
[1,]     5     4     7     5     6     6     7     4     7     1     6     3
[2,]     5     7     3     6     7     3     3     5     3     5     5     6
[3,]     7     7     2     2     4     6     5     4     3     6     3     1
[4,]     3     3     6     3     5     4     2     1     3     7     6     2
[5,]     2     2     2     6     7     7     6     5     1     4     3     4
[6,]     5     5     2     4     3     2     1     5     4     6     6     5
[7,]     4     1     5     1     1     2     4     4     3     2     2     3
     [,87] [,88] [,89] [,90] [,91] [,92] [,93] [,94] [,95] [,96] [,97] [,98]
[1,]     7     2     5     5     6     6     4     2     5     2     1     7
[2,]     4     7     1     2     2     6     4     1     7     2     3     7
[3,]     3     1     3     6     6     1     1     4     5     6     3     1
[4,]     7     2     3     5     7     5     7     3     4     5     5     7
[5,]     4     6     3     6     1     5     6     3     3     6     3     5
[6,]     1     3     5     1     3     4     1     5     3     6     3     7
[7,]     7     3     4     1     1     2     2     7     7     1     1     6
     [,99] [,100] [,101] [,102] [,103] [,104] [,105] [,106] [,107] [,108]
[1,]     3      2      3      7      5      2      3      1      5      3
[2,]     4      3      6      1      4      5      2      5      3      5
[3,]     4      2      7      7      5      7      2      7      1      5
[4,]     7      7      6      1      4      1      6      1      2      7
[5,]     3      6      7      7      7      5      4      6      2      4
[6,]     3      6      3      5      6      2      7      1      6      2
[7,]     3      7      6      7      3      2      4      6      4      6
     [,109] [,110] [,111] [,112] [,113] [,114] [,115] [,116] [,117] [,118]
[1,]      2      5      5      3      5      2      5      3      6      5
[2,]      6      3      3      1      6      4      2      6      7      3
[3,]      4      4      3      6      6      3      2      1      5      4
[4,]      6      1      6      1      7      7      1      7      1      1
[5,]      1      7      1      5      7      2      3      3      1      3
[6,]      6      6      4      1      2      7      5      5      6      1
[7,]      4      1      7      1      1      5      1      7      1      5
     [,119] [,120] [,121] [,122] [,123] [,124] [,125] [,126] [,127] [,128]
[1,]      7      6      4      4      2      7      5      6      7      5
[2,]      1      3      5      1      2      4      2      3      3      7
[3,]      4      1      3      5      3      3      6      6      4      2
[4,]      5      4      6      1      5      3      2      7      3      3
[5,]      3      1      3      6      7      3      2      5      6      5
[6,]      6      2      2      5      4      1      5      2      5      3
[7,]      6      6      2      4      7      2      5      4      7      1
     [,129] [,130] [,131] [,132] [,133] [,134] [,135] [,136] [,137] [,138]
[1,]      3      1      3      3      7      2      4      4      6      3
[2,]      5      4      6      1      2      2      6      7      2      7
[3,]      7      5      7      2      4      4      6      6      3      1
[4,]      2      5      2      6      2      5      7      2      7      7
[5,]      6      6      6      6      2      1      3      6      2      6
[6,]      5      6      1      3      1      5      7      7      4      2
[7,]      2      4      4      5      3      3      7      6      3      6
     [,139] [,140] [,141] [,142] [,143] [,144] [,145] [,146] [,147] [,148]
[1,]      3      2      3      5      4      7      7      5      1      1
[2,]      2      5      4      6      7      2      6      1      7      5
[3,]      4      3      7      7      7      6      4      7      1      5
[4,]      4      7      5      7      2      7      3      3      5      3
[5,]      4      2      3      2      3      7      5      5      2      1
[6,]      6      2      4      3      5      2      3      6      7      6
[7,]      7      5      4      7      1      7      2      4      7      4
     [,149] [,150] [,151] [,152] [,153] [,154] [,155] [,156] [,157] [,158]
[1,]      6      4      5      4      6      2      3      4      6      7
[2,]      6      4      3      5      5      4      3      1      6      2
[3,]      4      2      4      5      1      4      1      6      3      6
[4,]      1      1      3      5      5      3      2      1      1      7
[5,]      1      1      5      3      1      6      5      7      2      6
[6,]      7      4      4      1      7      5      7      6      4      1
[7,]      3      1      4      3      4      1      1      2      4      6
     [,159] [,160] [,161] [,162] [,163] [,164] [,165] [,166] [,167] [,168]
[1,]      6      4      3      5      7      3      5      2      3      6
[2,]      4      5      1      3      3      4      2      3      4      4
[3,]      5      4      2      5      4      2      7      2      1      6
[4,]      5      7      4      1      1      4      4      7      6      2
[5,]      6      6      6      2      7      5      3      4      7      1
[6,]      4      2      3      6      3      4      3      6      5      7
[7,]      5      4      5      5      1      7      5      5      2      7
     [,169] [,170] [,171] [,172] [,173] [,174] [,175] [,176] [,177] [,178]
[1,]      3      7      6      1      7      6      6      1      5      2
[2,]      6      1      3      5      7      2      1      6      5      7
[3,]      2      7      1      5      1      5      6      7      2      4
[4,]      4      6      7      1      1      5      2      3      7      5
[5,]      4      7      3      7      1      5      5      3      6      4
[6,]      1      7      3      4      6      3      4      1      1      7
[7,]      7      2      3      6      6      7      6      2      2      5
     [,179] [,180] [,181] [,182] [,183] [,184] [,185] [,186] [,187] [,188]
[1,]      1      6      6      7      1      4      2      2      4      3
[2,]      5      7      3      6      1      2      3      6      3      3
[3,]      2      3      1      2      2      5      5      6      7      5
[4,]      2      7      4      6      6      2      6      5      4      7
[5,]      3      4      4      1      2      1      7      2      6      7
[6,]      4      7      1      2      2      3      6      1      2      2
[7,]      4      6      5      1      5      7      3      5      1      2
     [,189] [,190] [,191] [,192] [,193] [,194] [,195] [,196] [,197] [,198]
[1,]      7      6      7      7      7      3      5      5      7      3
[2,]      6      5      7      1      1      7      4      6      3      5
[3,]      7      1      6      7      2      6      2      1      5      6
[4,]      4      2      7      4      1      1      4      1      1      6
[5,]      1      3      6      2      5      3      2      3      6      1
[6,]      7      6      1      2      1      6      2      6      5      7
[7,]      5      3      5      1      4      6      3      4      3      7
     [,199] [,200]
[1,]      6      4
[2,]      2      1
[3,]      7      5
[4,]      3      7
[5,]      6      4
[6,]      3      4
[7,]      2      6

> 
> names(LADmodel)
 [1] "coefficients"  "x"             "y"             "residuals"    
 [5] "dual"          "fitted.values" "formula"       "terms"        
 [9] "xlevels"       "call"          "tau"           "rho"          
[13] "method"        "model"        
> 
> results <- summary.rq(LADmodel,se="boot", R=200)
> head(results)
$call
rq(formula = price ~ year, data = growprice, model = TRUE, alpha = 0.05)

$terms
price ~ year
attr(,"variables")
list(price, year)
attr(,"factors")
      year
price    0
year     1
attr(,"term.labels")
[1] "year"
attr(,"order")
[1] 1
attr(,"intercept")
[1] 1
attr(,"response")
[1] 1
attr(,".Environment")
<environment: R_GlobalEnv>
attr(,"predvars")
list(price, year)
attr(,"dataClasses")
    price      year 
"numeric" "numeric" 

$coefficients
             Value Std. Error    t value  Pr(>|t|)
(Intercept) -2.460  4.6024027 -0.5345034 0.6158964
year         0.102  0.1057865  0.9642061 0.3792264

$residuals
     1      2      3      4      5      6      7 
 0.000 -0.092  0.076  0.714  0.022  0.000 -0.292 

$rdf
[1] 5

$tau
[1] 0.5

> 
> coef(results)[1,1]
[1] -2.46
> coef(results)[1,2]
[1] 4.602403
> coef(results)[2,1]
[1] 0.102
> coef(results)[2,2]
[1] 0.1057865
> 
> coef(results)[2,1]+ c(-1,1)*1.96*coef(results)[2,2]  #bootstrap CI on slope parameter
[1] -0.1053416  0.3093416
> 
> plot(price~year,growprice)
> abline(lmod,col="red",lty=2)
> abline(LADmodel,col="blue",lty=1)
> 
> eiRob <- resid(LADmodel)
> sum(abs(eiRob)) #this quantity is minimized in LAD 
[1] 1.196
> 
> eisq2Rob <- eiRob^2
> sum(eisq)
[1] 0.5637393
> sum(eisq2Rob)  #this quantity should be bigger than the OLS sum(eisq2)
[1] 0.609784
> 
> eiRob
     1      2      3      4      5      6      7 
 0.000 -0.092  0.076  0.714  0.022  0.000 -0.292 
> plot(ecdf(eiRob)) #plots the ecdf for the residuals from the LAD model
> 
> plot(ei~year,growprice,ylim=c(-.3,.8),col="red")
> par(new=TRUE)  #plot the next plot using the same axes as the previous plot
> plot(eiRob~year,growprice,axes=F,xlab=" ",ylab=" ",col="blue")
> 
> #----------------------------------------------------#
> dev.off()
null device 
          1 
> 
